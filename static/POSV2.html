<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS ç³»çµ± - åº—å“¡æ“ä½œç«¯</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      background-color: #f5f5f5;
      color: #000;
    }
    .pos-container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .section-title {
      margin-top: 30px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .recommend-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      background: #fdfdfd;
      text-align: center;
    }
    .recommend-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
    }
    .badge {
      margin: 2px;
    }
    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px dashed #aaa;
    }
  </style>
</head>
<body>
  
  <div class="pos-container">
    <h4>POS ç³»çµ± - åº—å“¡æ“ä½œç«¯</h4>

    <!-- æœƒå“¡è¼¸å…¥ -->
    <div class="input-group mb-3">
      <span class="input-group-text">æœƒå“¡ ID / æ¢ç¢¼</span>
      <input type="text" id="memberInput" class="form-control" placeholder="è«‹è¼¸å…¥æˆ–æƒææœƒå“¡æ¢ç¢¼" onkeydown="handleMemberKey(event)">
    </div>

    <div class="d-flex justify-content-between">
      <div>æœƒå“¡ IDï¼š<strong id="memberDisplay">å°šæœªè¾¨è­˜</strong></div>
      <div>æ™‚é–“ï¼š<span id="datetime">--:--</span></div>
    </div>

    <!-- é¡§å®¢è³¼ç‰©æ¸…å–® -->
    <div class="section-title mt-4"><strong>é¡§å®¢è³¼ç‰©æ¸…å–®</strong></div>
    <div id="itemList"></div>

    <!-- å•†å“æ¢ç¢¼è¼¸å…¥ -->
    <div class="section-title"><strong>æ–°å¢å•†å“ï¼ˆæ¢ç¢¼æƒæ / æ‰‹å‹•è¼¸å…¥ï¼‰</strong></div>
    <div class="input-group mb-3">
      <span class="input-group-text">å•†å“æ¢ç¢¼</span>
      <input type="text" id="productInput" class="form-control" placeholder="è«‹è¼¸å…¥æˆ–æƒæå•†å“æ¢ç¢¼" onkeydown="handleProductKey(event)">
    </div>

    <!-- æ¨è–¦å•†å“å€ -->
    <div class="section-title"><strong>ç³»çµ±æ¨è–¦å•†å“</strong></div>
    <div class="row" id="recommendList"></div>

    <!-- åº•éƒ¨æ§åˆ¶æŒ‰éˆ• -->
    <div class="text-end mt-4">
      <button class="btn btn-success" onclick="checkout()">âœ… ç¢ºèªçµå¸³</button>
      <button class="btn btn-secondary ms-2" onclick="resetCustomer()">ğŸ”„ ä¸‹ä¸€ä½é¡§å®¢</button>
    </div>
  </div>
 

  <script>
    const productDB = {};
    const recommendations = [];
    const items = [];
    const socket = io(); // âœ… åˆå§‹åŒ– socket
function loadProductsFromCSV() {
  fetch("/products.csv")
    .then(res => res.text())
    .then(data => {
      const lines = data.trim().split("\n");
      const headers = lines[0].replace(/\r/g, "").split(",");

      console.log("æ¬„ä½é †åºï¼š", headers);

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].match(/(".*?"|[^",]+)(?=,|$)/g)?.map(c => c.replace(/^"|"$/g, '').trim());
        if (!cols) continue;

        const id = cols[headers.indexOf("å•†å“ID")]?.trim();  // âœ… æ”¹ç”¨ å•†å“ID ç‚º key
        const name = cols[headers.indexOf("å•†å“åç¨±")]?.trim();
        const tagsRaw = cols[headers.indexOf("æ¨™ç±¤")]?.trim();
        const tags = tagsRaw ? tagsRaw.split(",").map(t => t.trim()) : [];
        const price = 10;

        if (id && name) {
          productDB[id] = { name, price, tags };
          console.log("âœ… è¼‰å…¥å•†å“ï¼š", id, name);
        }
      }

      console.log("âœ… å•†å“è³‡æ–™è¼‰å…¥å®Œæˆï¼š", productDB);
    });
}
let code = document.getElementById("productInput").value.trim().replace(/\*/g, "");

  function addToCart(name, price) {
  const found = items.find(i => i.name === name);
  if (found) {
    found.quantity += 1;
  } else {
    items.push({ name, price, quantity: 1 });
  }
  renderItemList();
  syncToCustomer();  // âœ… åŒæ­¥çµ¦é¡§å®¢ç«¯
}


    function renderItemList() {
      const list = document.getElementById("itemList");
      list.innerHTML = "";
      let total = 0;
      items.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        list.innerHTML += `
          <div class="item-row">
            <span>${item.name}</span>
            <span>
              <button onclick="updateQuantity(${index}, -1)">-</button>
              <span style="margin: 0 10px;">${item.quantity}</span>
              <button onclick="updateQuantity(${index}, 1)">+</button>
              &nbsp; $${subtotal}
            </span>
          </div>
        `;
      });
      list.innerHTML += `<div class="item-row"><strong>ç¸½è¨ˆ</strong><strong>$${total}</strong></div>`;
    }

    function updateQuantity(index, change) {
      items[index].quantity += change;
      if (items[index].quantity < 1) items[index].quantity = 1;
      renderItemList();
    }

    function addToCart(name, price) {
      const found = items.find(i => i.name === name);
      if (found) {
        found.quantity += 1;
      } else {
        items.push({ name, price, quantity: 1 });
      }
      renderItemList();
    }

    function renderRecommendations() {
      const container = document.getElementById("recommendList");
      container.innerHTML = "";
      recommendations.forEach(rec => {
        const tagsHtml = rec.tags.map(tag => `<span class="badge bg-info text-dark">${tag}</span>`).join(" ");
        container.innerHTML += `
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="recommend-card">
              <img src="${rec.image}" alt="${rec.name}">
              <div class="mt-2"><strong>${rec.name}</strong></div>
              <div>${tagsHtml}</div>
              <small class="text-muted">${rec.reason}</small>
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="addToCart('${rec.name}', ${rec.price})">åŠ å…¥æ¸…å–®</button>
            </div>
          </div>
        `;
      });
    }

    function handleMemberKey(e) {
      if (e.key === "Enter") {
        const memberId = document.getElementById("memberInput").value.trim();
        if (memberId !== "") {
          document.getElementById("memberDisplay").textContent = memberId;
          alert(`âœ… æˆåŠŸè¾¨è­˜æœƒå“¡ï¼š${memberId}`);
          document.getElementById("memberInput").value = "";
        }syncToCustomer()
      }
    }

    function handleProductKey(e) {
      if (e.key === "Enter") {
        const code = document.getElementById("productInput").value.trim();
        if (productDB[code]) {
          const { name, price } = productDB[code];
          addToCart(name, price);
          alert(`ğŸ“¦ å·²åŠ å…¥å•†å“ï¼š${name}`);
        } else {
          alert("âš ï¸ æŸ¥ç„¡å•†å“æ¢ç¢¼ï¼š" + code);
        }
        document.getElementById("productInput").value = "";
      }
    }

    function checkout() {
      alert("âœ… çµå¸³æˆåŠŸï¼Œç¸½é‡‘é¡ $" + calculateTotal());
    }

    function resetCustomer() {
      items.length = 0;
      document.getElementById("memberDisplay").textContent = "å°šæœªè¾¨è­˜";
      renderItemList();
      alert("ğŸ”„ å·²åˆ‡æ›åˆ°ä¸‹ä¸€ä½é¡§å®¢");
    }

    function calculateTotal() {
      return items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    }
    socket.emit("update", {
  member: document.getElementById("memberDisplay").textContent,
  items: items,
  recommendations: []
});

    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString() + ' - ' + now.toLocaleDateString('zh-Hant', {
        year: 'numeric',
        month: 'long',
        day: '2-digit'
      });
      document.getElementById('datetime').textContent = timeString;
    }
  function syncToCustomer() {
  socket.emit("update", {
    member: document.getElementById("memberDisplay").textContent,
    items: items,
    recommendations: [] // âœ… è‹¥æœ‰æ¨è–¦æ¸…å–®å¯ä»¥åŠ å…¥
  });
}

    // åˆå§‹åŒ–æ™‚è‡ªå‹•è¼‰å…¥å•†å“è³‡æ–™
  window.onload = function () {
  loadProductsFromCSV();
  updateTime();
  setInterval(updateTime, 1000);
  renderItemList();
  renderRecommendations();
  syncToCustomer(); // âœ… åˆå§‹åŒæ­¥çµ¦é¡§å®¢ç«¯
};



  </script>
</body>
</html>
